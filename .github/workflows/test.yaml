name: terratorch tuning toolkit

on: 
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'tests/resources/**'
      - 'examples/**/*'
      - '**/*.svg'
      - '**/*.png'
      - '**/*.txt'
      - '**/*.ipynb'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'tests/resources/**'
      - 'examples/**/*'
      - '**/*.svg'
      - '**/*.png'
      - '**/*.txt'
      - '**/*.ipynb'
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    env:
      R_TESTS_VERBOSE: 2
    steps:
      - name: Clone repo
        uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          #python -m pip install --upgrade pip
          pip install pip==24.2
          pip --version
          pip install -e .[wxc,galileo,test]
      - name: Clean pip cache
        run: pip cache purge
      - name: List pip dependencies
        run: pip list
      - name: Cleaning cache
        run: pip cache purge
      #- name: Test with pytest
      #  run: |
      #    pytest -s --cov=terratorch -v --cov-report term-missing tests
      - name: Install vLLM dependencies
        run: |
          sudo apt install -y --no-install-recommends ccache git curl wget ca-certificates gcc-12 g++-12 libtcmalloc-minimal4 libnuma-dev ffmpeg libsm6 libxext6 libgl1 jq lsof
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 --slave /usr/bin/g++ g++ /usr/bin/g++-12
      - name: Test vLLM
        run: |
          cd /home/runner/work
          git clone https://github.com/vllm-project/vllm.git
          cd vllm
          pip install -r requirements/cpu-build.txt
          pip install -r requirements/cpu.txt
          pip install -r requirements/lint.txt
          VLLM_TARGET_DEVICE=cpu python setup.py install
          pre-commit run --show-diff-on-failure --color=always --all-files

